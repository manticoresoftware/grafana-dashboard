services:
  init:
    image: alpine:3.20
    container_name: manticore-init
    volumes:
      - ./monitoring:/monitoring
    entrypoint:
      - /bin/sh
      - -c
      - |
        apk add --no-cache curl >/dev/null 2>&1
        base="https://raw.githubusercontent.com/manticoresoftware/manticoresearch-buddy/feat/improve-grafana-dashboards/monitoring"
        mkdir -p /monitoring/grafana /monitoring/prometheus

        fetch() {
          src="$${base}/$$1"
          dst="/monitoring/$$1"
          tmp="$${dst}.tmp"
          curl -fsSL "$${src}" -o "$${tmp}"
          if [ -f "$${dst}" ] && [ "$$(sha256sum "$${tmp}" | cut -d' ' -f1)" = "$$(sha256sum "$${dst}" | cut -d' ' -f1)" ]; then
            rm "$${tmp}"
            echo "$$1: up to date"
          else
            mv "$${tmp}" "$${dst}"
            echo "$$1: updated"
          fi
        }

        fetch grafana/manticore-dashboard.json
        fetch prometheus/manticore-alerts.yml

  prometheus:
    image: prom/prometheus:v2.52.0
    container_name: manticore-prometheus
    depends_on:
      init:
        condition: service_completed_successfully
    entrypoint:
      - /bin/sh
      - -c
      - |
        targets=""
        IFS=','
        for t in $${MANTICORE_TARGETS}; do
          targets="$${targets}\n          - \"$${t}\""
        done
        sed "s|targets: \[\]|targets:$${targets}|" \
          /etc/prometheus/prometheus.yml.tmpl > /etc/prometheus/prometheus.yml
        echo "Prometheus targets: $${MANTICORE_TARGETS}"
        exec /bin/prometheus \
          --config.file=/etc/prometheus/prometheus.yml \
          --web.enable-lifecycle
    environment:
      MANTICORE_TARGETS: ${MANTICORE_TARGETS:-host.docker.internal:9308}
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml.tmpl:ro
      - ./monitoring/prometheus:/etc/prometheus/rules:ro
      - prometheus-data:/prometheus
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - app-network

  grafana:
    image: grafana/grafana-oss:10.4.3
    container_name: manticore-grafana
    depends_on:
      init:
        condition: service_completed_successfully
      prometheus:
        condition: service_started
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_AUTH_ANONYMOUS_ENABLED: "false"
    ports:
      - "3000:3000"
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana:/var/lib/grafana/dashboards/buddy:ro
      - grafana-data:/var/lib/grafana
    networks:
      - app-network

volumes:
  grafana-data:
  prometheus-data:

networks:
  app-network:
    driver: bridge
